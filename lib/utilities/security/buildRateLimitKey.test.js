const buildRateLimitKey=require(./buildRateLimitKey);describe('buildRateLimitKey',()=>{it('should build IP-based key by default',()=>{const req ={ip: '192.168.1.1'};expect(buildRateLimitKey(req)).toBe('rl:192.168.1.1')});it('should use custom prefix',()=>{const req ={ip: '10.0.0.1'};expect(buildRateLimitKey(req,{prefix: 'api'})).toBe('api:10.0.0.1')});it('should fallback to connection.remoteAddress',()=>{const req ={connection:{remoteAddress: '172.16.0.1'}};expect(buildRateLimitKey(req)).toBe('rl:172.16.0.1')});it('should handle missing IP gracefully',()=>{expect(buildRateLimitKey({})).toBe('rl:unknown-ip');expect(buildRateLimitKey({ip: null})).toBe('rl:unknown-ip')});it('should build user-based key',()=>{const req ={user:{id: 'user123'}};expect(buildRateLimitKey(req,{strategy: 'user'})).toBe('rl:user123')});it('should support custom user ID path',()=>{const req ={auth:{userId: 'auth456'}};expect(buildRateLimitKey(req,{strategy: 'user',userIdPath: 'auth.userId'})).toBe('rl:auth456')});it('should handle missing user gracefully',()=>{expect(buildRateLimitKey({},{strategy: 'user'})).toBe('rl:unknown-user')});it('should build API key-based key with hash',()=>{const req ={validatedApiKey: 'sk_live_abc123'},key=buildRateLimitKey(req,{strategy: 'apiKey'});expect(key).toMatch(/^rl:key_[a-z0-9]+$/)});it('should support custom API key path',()=>{const req ={auth:{apiKey: 'pk_test_xyz'}},key=buildRateLimitKey(req,{strategy: 'apiKey',apiKeyPath: 'auth.apiKey'});expect(key).toMatch(/^rl:key_[a-z0-9]+$/)});it('should handle missing API key gracefully',()=>{expect(buildRateLimitKey({},{strategy: 'apiKey'})).toBe('rl:unknown-key')});it('should build custom key',()=>{const req ={headers:{'x-tenant': 'tenant-abc'}},customKeyFn =(r)=>r.headers['x-tenant'];expect(buildRateLimitKey(req,{strategy: 'custom',customKeyFn})).toBe('rl:tenant-abc')});it('should handle custom function returning null',()=>{const req ={},customKeyFn =()=>null;expect(buildRateLimitKey(req,{strategy: 'custom',customKeyFn})).toBe('rl:custom-unknown')});it('should handle unknown strategy',()=>{const req ={ip: '1.2.3.4'};expect(buildRateLimitKey(req,{strategy: 'unknown'})).toBe('rl:1.2.3.4')});it('should produce consistent hash for same API key',()=>{const req1={validatedApiKey: 'test-key-123'},req2 ={validatedApiKey: 'test-key-123'},key1=buildRateLimitKey(req1,{strategy: 'apiKey'}),key2=buildRateLimitKey(req2,{strategy: 'apiKey'});expect(key1).toBe(key2)});it('should produce different hash for different API keys',()=>{const req1={validatedApiKey: 'key-a'},req2 ={validatedApiKey: 'key-b'},key1=buildRateLimitKey(req1,{strategy: 'apiKey'}),key2=buildRateLimitKey(req2,{strategy: 'apiKey'});expect(key1).not.toBe(key2)})});