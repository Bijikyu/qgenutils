'use strict';const collectPerformanceMetrics=require(./collectPerformanceMetrics);describe('collectPerformanceMetrics',()=>{it('should return metrics and state objects',()=>{const result=collectPerformanceMetrics();expect(result).toHaveProperty('metrics');expect(result).toHaveProperty('state')});it('should include all required metric fields',()=>{const{metrics}=collectPerformanceMetrics();expect(metrics).toHaveProperty('eventLoopLag');expect(metrics).toHaveProperty('cpuUsage');expect(metrics).toHaveProperty('memoryUsage');expect(metrics).toHaveProperty('activeHandles');expect(metrics).toHaveProperty('activeRequests');expect(metrics).toHaveProperty('heapUsedPercent');expect(metrics).toHaveProperty('responseTime');expect(metrics).toHaveProperty('throughput');expect(metrics).toHaveProperty('timestamp')});it('should return valid memory usage from process',()=>{const{metrics}=collectPerformanceMetrics();expect(metrics.memoryUsage).toHaveProperty('heapUsed');expect(metrics.memoryUsage).toHaveProperty('heapTotal');expect(metrics.memoryUsage).toHaveProperty('rss');expect(typeof metrics.memoryUsage.heapUsed).toBe('number')});it('should calculate heap used percent correctly',()=>{const{metrics}=collectPerformanceMetrics();expect(metrics.heapUsedPercent).toBeGreaterThan(0);expect(metrics.heapUsedPercent).toBeLessThanOrEqual(100)});it('should use provided state for calculations',()=>{const now=Date.now(),initialState ={lastCpuUsage: process.cpuUsage(),responseTimes: [100,200,300],requestTimestamps: [now-30000,now-20000,now-10000],lastCollectionTime: now-5000};const{metrics}=collectPerformanceMetrics(initialState);expect(metrics.responseTime).toBe(200);expect(metrics.throughput).toBe(3)});it('should return updated state for next call',()=>{const{state}=collectPerformanceMetrics();expect(state).toHaveProperty('lastCpuUsage');expect(state).toHaveProperty('responseTimes');expect(state).toHaveProperty('requestTimestamps');expect(state).toHaveProperty('lastCollectionTime')});it('should filter out old request timestamps',()=>{const now=Date.now(),initialState ={requestTimestamps: [now-120000,now-90000,now-30000,now-10000],lastCollectionTime: now-5000};const{metrics,state}=collectPerformanceMetrics(initialState);expect(metrics.throughput).toBe(2);expect(state.requestTimestamps.length).toBe(2)});it('should handle empty state gracefully',()=>{const{metrics}=collectPerformanceMetrics({});expect(metrics.responseTime).toBe(0);expect(metrics.throughput).toBe(0)})});