name: QGenUtils CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: ["v*"]

env:
  NODE_VERSION: 18
  NODE_ENV: test

jobs:
  test-and-security-scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16, 18, 20]
    services:
      test:
        image: node:${{ matrix.node-version }}-alpine
        steps:
          - uses: actions/checkout@v4
          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node-version }}
              cache: 'npm'
          - name: Install dependencies
            run: npm ci
          - name: Run unit tests
            run: npm test -- --coverage
          - name: Upload coverage
            uses: actions/upload-artifact@v4
            with:
              name: coverage-reports-node-${{ matrix.node-version }}
              path: coverage/
          - name: Run integration tests
            run: node scripts/test-demo-endpoints.cjs
          - name: Run security scan
            run: node scripts/security-scanner.cjs
          - name: Analyze security report
            run: |
              const fs = require('fs');
              const report = JSON.parse(fs.readFileSync('security-scan-${{ matrix.node-version }}.json'));
              console.log('ðŸ”’ Security Analysis:');
              console.log('Vulnerabilities:', report.summary.vulnerabilities || 0);
              console.log('Security Score:', report.summary.securityScore || 0);
              console.log('Recommendations:', report.recommendations?.length || 0);
              if (report.summary.vulnerabilities > 0) {
                process.exit(1);
              }

  build-and-deploy:
    needs: test-and-security-scan
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        environment: [staging, production]
    services:
      build:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - name: Setup Docker Buildx
            uses: docker/setup-buildx-action@v3
          - name: Build and push demo image
            uses: docker/build-push-action@v5
            with:
              context: ${{ matrix.environment }}
              push: true
              tags: qgenutils-demo-${{ matrix.environment }}
              file: Dockerfile
            env:
              REGISTRY: ghcr.io
              IMAGE_NAME: ${{ github.repository }}
      
      deploy-staging:
        needs: build
        runs-on: ubuntu-latest
        environment: staging
        steps:
          - name: Deploy to staging
            run: |
              echo "ðŸš€ Deploying to staging..."
              # Simulate deployment commands
              echo "Image: qgenutils-demo-staging"
              echo "Registry: ghcr.io/${{ github.repository }}"
              echo "Environment: staging"
              echo "Deploying application with health check..."

      deploy-production:
        needs: build
        if: github.ref == 'refs/heads/main'
          runs-on: ubuntu-latest
        environment: production
        steps:
          - name: Deploy to production
            run: |
              echo "ðŸš€ Deploying to production..."
              # Simulate deployment commands
              echo "Image: qgenutils-demo-production"
              echo "Registry: ghcr.io/${{ github.repository }}"
              echo "Environment: production"
              echo "Deploying application with full health validation..."

      notify-deployment:
    needs: test-and-security-scan
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Send security alert
        run: |
          echo "ðŸš¨ SECURITY ALERT: Vulnerabilities detected in CI/CD pipeline"
          echo "Vulnerabilities: ${{ needs.security-scan.outputs.vulnerabilities }}"
          echo "Check GitHub Actions for detailed security analysis"

  notify-deployment:
    needs: deploy-staging || deploy-production
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Send deployment notification
        run: |
              echo "âœ… Deployment successful!"
              echo "Environment: ${{ needs.deploy-staging.outputs.environment || needs.deploy-production.outputs.environment }}"
              echo "Image: qgenutils-demo-${{ needs.deploy-staging.outputs.environment || needs.deploy-production.outputs.environment }}"
              echo "Deployed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

  # Security scanning job that creates outputs for other jobs
  security-scan:
    runs-on: ubuntu-latest
    outputs:
      vulnerabilities: ${{ steps.analyze.outputs.vulnerabilities }}
      security-score: ${{ steps.analyze.outputs.security-score }}
      needs-security-scan: ${{ steps.analyze.outputs.needs-security-scan }}
    steps:
      - name: Run comprehensive security scan
        run: |
          node scripts/security-scanner.cjs
      
      - name: Analyze security report
        id: analyze
        run: |
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('security-scan-${{ matrix.node-version }}.json'));
          
          # Set outputs for other jobs
          echo "vulnerabilities=${{ report.summary.vulnerabilities || 0 }}" >> $GITHUB_OUTPUT
          echo "security-score=${{ report.summary.securityScore || 0 }}" >> $GITHUB_OUTPUT
          echo "needs-security-scan=${{ report.summary.vulnerabilities > 0 }}" >> $GITHUB_OUTPUT
          
          console.log('ðŸ”’ Security Analysis Complete');
          console.log('Total Vulnerabilities:', report.summary.vulnerabilities || 0);
          console.log('Security Score:', report.summary.securityScore || 0);
          console.log('Recommendations:', report.recommendations?.length || 0);
          
          if (report.summary.vulnerabilities > 0) {
            echo "âŒ SECURITY ISSUES FOUND - Deployment Blocked" >> $GITHUB_OUTPUT
            exit 1
          } else {
            echo "âœ… Security Scan Passed" >> $GITHUB_OUTPUT
          }

  # Upload coverage reports
  upload-coverage:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: ${{ matrix.flags }}
          name: codecov-umbrella
          fail_ci_if_error: true