<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QGenUtils Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 {
            color: #2563eb;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #2563eb;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            color: #333;
        }

        .metric-value.good {
            color: #10b981;
        }

        .metric-value.warning {
            color: #f59e0b;
        }

        .metric-value.error {
            color: #ef4444;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-good {
            background: #10b981;
        }

        .status-warning {
            background: #f59e0b;
        }

        .status-error {
            background: #ef4444;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn.danger {
            background: #ef4444;
        }

        .btn.danger:hover {
            background: #dc2626;
        }

        .refresh-indicator {
            display: none;
            margin-left: 10px;
            font-size: 12px;
            color: #666;
        }

        .loading .refresh-indicator {
            display: inline;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            height: 400px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        .log-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .log-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-entry.info {
            background: #dbeafe;
        }

        .log-entry.warn {
            background: #fef3c7;
        }

        .log-entry.error {
            background: #fee2e2;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß QGenUtils Admin Dashboard</h1>
            <p style="color: #666; margin-top: 10px;">Real-time server monitoring and management</p>
        </header>

        <div class="dashboard-grid">
            <!-- Server Status Card -->
            <div class="card">
                <h3>üü¢ Server Status</h3>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="server-status">
                        <span class="status-indicator status-good"></span>
                        Online
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value" id="uptime">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Version</span>
                    <span class="metric-value">2.0.0</span>
                </div>
                <div class="control-buttons">
                    <button class="btn" onclick="refreshDashboard()">
                        üîÑ Refresh
                        <span class="refresh-indicator">Refreshing...</span>
                    </button>
                    <button class="btn danger" onclick="clearCache()">
                        üóÑÔ∏è Clear Cache
                    </button>
                </div>
            </div>

            <!-- Performance Metrics Card -->
            <div class="card">
                <h3>üìä Performance</h3>
                <div class="metric">
                    <span class="metric-label">Total Requests</span>
                    <span class="metric-value" id="total-requests">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Response Time</span>
                    <span class="metric-value" id="avg-response-time">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Error Rate</span>
                    <span class="metric-value" id="error-rate">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Requests/min</span>
                    <span class="metric-value" id="requests-per-minute">--</span>
                </div>
            </div>

            <!-- Rate Limiting Card -->
            <div class="card">
                <h3>üö¶ Rate Limiting</h3>
                <div class="metric">
                    <span class="metric-label">Active Clients</span>
                    <span class="metric-value" id="active-clients">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Blocked Requests</span>
                    <span class="metric-value" id="blocked-requests">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Rate Limited</span>
                    <span class="metric-value" id="rate-limited">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Quota Entries</span>
                    <span class="metric-value" id="quota-entries">--</span>
                </div>
            </div>

            <!-- Cache Metrics Card -->
            <div class="card">
                <h3>üíæ Cache Performance</h3>
                <div class="metric">
                    <span class="metric-label">Hit Rate</span>
                    <span class="metric-value" id="cache-hit-rate">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Cache Size</span>
                    <span class="metric-value" id="cache-size">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Memory Usage</span>
                    <span class="metric-value" id="cache-memory">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Evictions</span>
                    <span class="metric-value" id="cache-evictions">--</span>
                </div>
            </div>

            <!-- System Resources Card -->
            <div class="card">
                <h3>üñ•Ô∏è System Resources</h3>
                <div class="metric">
                    <span class="metric-label">Memory Usage</span>
                    <span class="metric-value" id="memory-usage">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Heap Used</span>
                    <span class="metric-value" id="heap-used">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">CPU Usage</span>
                    <span class="metric-value" id="cpu-usage">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Platform</span>
                    <span class="metric-value" id="platform">--</span>
                </div>
            </div>

            <!-- Security Card -->
            <div class="card">
                <h3>üîí Security</h3>
                <div class="metric">
                    <span class="metric-label">Suspicious Requests</span>
                    <span class="metric-value" id="suspicious-requests">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Security Events</span>
                    <span class="metric-value" id="security-events">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">IP Blocks</span>
                    <span class="metric-value" id="ip-blocks">--</span>
                </div>
                <div class="control-buttons">
                    <button class="btn" onclick="viewAuditLog()">
                        üìã View Audit Log
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Logs Section -->
        <div class="log-section">
            <h3>üìú Recent Server Logs</h3>
            <div class="log-container" id="log-container">
                <div class="log-entry info">Loading logs...</div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification">
        <span id="notification-message"></span>
    </div>

    <script>
        // API configuration with protocol security
        const API_BASE = (window.location.protocol === 'https:' ? 'https:' : 'http:') + '//' + 
                         window.location.hostname + 
                         (window.location.port ? ':' + window.location.port : '') + '/api';
        
        let dashboardData = null;
        let refreshInterval = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
            startAutoRefresh();
        });

        // Refresh dashboard data
        async function refreshDashboard() {
            try {
                document.body.classList.add('loading');
                
                const response = await fetch(API_BASE + '/stats', {
                    signal: AbortSignal.timeout(10000) // 10 second timeout
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                dashboardData = await response.json();
                updateMetrics();
                updateRecentLogs();
                
                showNotification('Dashboard refreshed successfully', 'success');
                updateServerStatus(true);
                
            } catch (error) {
                console.error('Failed to refresh dashboard:', error);
                if (error.name === 'AbortError') {
                    showNotification('Dashboard refresh timed out. Please check your connection.', 'error');
                } else if (error.message.includes('Failed to fetch')) {
                    showNotification('Unable to connect to server. Please ensure the backend is running.', 'error');
                } else {
                    showNotification('Failed to refresh dashboard: ' + error.message, 'error');
                }
                updateServerStatus(false);
                // Use cached data if available
                if (dashboardData) {
                    updateMetrics();
                    updateRecentLogs();
                    showNotification('Using cached data while offline', 'warning');
                    updateServerStatus(true);
                    return;
                }
                
                // Set default values when API is not available
                dashboardData = {
                    requestCount: 0,
                    avgResponseTime: 0,
                    errorRate: 0,
                    rateLimiting: {
                        activeClients: 0,
                        blockedRequests: 0,
                        rateLimitedRequests: 0,
                        quotaEntries: 0
                    },
                    caching: {
                        hitRate: 0,
                        cacheSize: 0,
                        memoryUsage: 0,
                        evictions: 0
                    },
                    system: {
                        uptime: 0,
                        memory: {
                            rss: 0,
                            heapUsed: 0
                        },
                        platform: 'Unknown'
                    }
                };
                updateMetrics();
            } finally {
                document.body.classList.remove('loading');
            }
        }

        // Update all metric displays
	        function updateMetrics() {
	            if (!dashboardData) return;

	            document.getElementById('uptime').textContent = formatUptime(dashboardData.system?.uptime || 0);
	            
	            // Performance Metrics
            document.getElementById('total-requests').textContent = 
                dashboardData.requestCount?.toLocaleString() || '--';
            document.getElementById('avg-response-time').textContent = 
                (dashboardData.avgResponseTime || 0).toFixed(2) + 'ms';
            document.getElementById('error-rate').textContent = 
                (dashboardData.errorRate || 0).toFixed(2) + '%';
            
            // Rate Limiting
            const rateLimiting = dashboardData.rateLimiting || {};
            document.getElementById('active-clients').textContent = 
                rateLimiting.activeClients?.toLocaleString() || '--';
            document.getElementById('blocked-requests').textContent = 
                rateLimiting.blockedRequests?.toLocaleString() || '--';
            document.getElementById('rate-limited').textContent = 
                rateLimiting.rateLimitedRequests?.toLocaleString() || '--';
            document.getElementById('quota-entries').textContent = 
                rateLimiting.quotaEntries?.toLocaleString() || '--';
            
            // Cache Metrics
            const caching = dashboardData.caching || {};
            document.getElementById('cache-hit-rate').textContent = 
                (caching.hitRate || 0).toFixed(1) + '%';
            document.getElementById('cache-size').textContent = 
                caching.cacheSize?.toLocaleString() || '--';
            document.getElementById('cache-memory').textContent = 
                (caching.memoryUsage || 0).toLocaleString() + ' KB';
            document.getElementById('cache-evictions').textContent = 
                caching.evictions?.toLocaleString() || '--';
            
            // System Resources
            const memory = dashboardData.system?.memory || {};
            const heapUsedMB = Math.round((memory.heapUsed || 0) / 1024 / 1024);
            document.getElementById('memory-usage').textContent = 
                Math.round((memory.rss || 0) / 1024 / 1024) + ' MB';
            document.getElementById('heap-used').textContent = heapUsedMB + ' MB';
            document.getElementById('platform').textContent = 
                dashboardData.system?.platform || '--';
            
            // Update value colors based on thresholds
            updateMetricColors();
        }

        function updateServerStatus(isOnline) {
            const statusEl = document.getElementById('server-status');
            const indicator = statusEl.querySelector('.status-indicator');
            
            if (isOnline) {
                indicator.className = 'status-indicator status-good';
                statusEl.innerHTML = '<span class="status-indicator status-good"></span>Online';
            } else {
                indicator.className = 'status-indicator status-error';
                statusEl.innerHTML = '<span class="status-indicator status-error"></span>Offline';
            }
        }

        function updateMetricColors() {
            if (!dashboardData) return;

            // Response time colors
            const avgTime = dashboardData.avgResponseTime || 0;
            const timeEl = document.getElementById('avg-response-time');
            if (avgTime < 100) {
                timeEl.className = 'metric-value good';
            } else if (avgTime < 500) {
                timeEl.className = 'metric-value warning';
            } else {
                timeEl.className = 'metric-value error';
            }

            // Error rate colors
            const errorRate = dashboardData.errorRate || 0;
            const errorEl = document.getElementById('error-rate');
            if (errorRate < 1) {
                errorEl.className = 'metric-value good';
            } else if (errorRate < 5) {
                errorEl.className = 'metric-value warning';
            } else {
                errorEl.className = 'metric-value error';
            }

            // Cache hit rate colors
            const hitRate = dashboardData.caching?.hitRate || 0;
            const cacheEl = document.getElementById('cache-hit-rate');
            if (hitRate > 80) {
                cacheEl.className = 'metric-value good';
            } else if (hitRate > 50) {
                cacheEl.className = 'metric-value warning';
            } else {
                cacheEl.className = 'metric-value error';
            }
        }

        function updateRecentLogs() {
            const logContainer = document.getElementById('log-container');
            
            // Mock recent logs (in real implementation, would fetch from server)
            const mockLogs = [
                { level: 'info', message: 'Dashboard accessed', time: new Date().toISOString() },
                { level: 'info', message: 'Cache performance optimized', time: new Date().toISOString() },
                { level: 'warn', message: 'High memory usage detected', time: new Date().toISOString() },
                { level: 'info', message: 'Rate limiting thresholds updated', time: new Date().toISOString() }
            ];
            
            logContainer.innerHTML = '';
            mockLogs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${log.level}`;
                logEntry.textContent = `[${new Date(log.time).toLocaleTimeString()}] ${log.message}`;
                logContainer.appendChild(logEntry);
            });
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notification-message');
            
            messageEl.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function startAutoRefresh() {
            // Refresh every 30 seconds
            refreshInterval = setInterval(refreshDashboard, 30000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Control functions
        window.refreshDashboard = function() {
            stopAutoRefresh();
            refreshDashboard().then(() => {
                startAutoRefresh();
            });
        };

        window.clearCache = async function() {
            try {
                const response = await fetch(API_BASE + '/cache/clear', { method: 'POST' });
                if (response.ok) {
                    showNotification('Cache cleared successfully', 'success');
                    setTimeout(refreshDashboard, 1000);
                } else {
                    throw new Error('Failed to clear cache');
                }
            } catch (error) {
                showNotification('Failed to clear cache: ' + error.message, 'error');
            }
        };

        window.viewAuditLog = function() {
            showNotification('Audit log feature coming soon', 'info');
        };

        // Clean up on page unload
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>
</body>
</html>
