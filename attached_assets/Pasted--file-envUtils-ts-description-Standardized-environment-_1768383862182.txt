/**
 * @file envUtils.ts
 * @description Standardized environment variable access utilities
 */

import { qgenutils } from './commonImports.js';

/**
 * Standardized environment variable access with fallbacks
 * @param varName - Environment variable name
 * @param defaultValue - Default value if not found
 * @param type - Expected type ('string', 'number', 'boolean')
 * @returns Environment variable value or default
 */
export const getEnvVar = (
  varName: string,
  defaultValue?: string | number | boolean,
  type: 'string' | 'number' | 'boolean' = 'string'
): string | number | boolean | undefined => {
  // Try qgenutils first
  const qgenValue = (qgenutils as any).getEnvVar?.(varName, undefined, type);
  
  if (qgenValue !== undefined && qgenValue !== null) {
    if (type === 'string') {
      const trimmed = String(qgenValue).trim();
      return trimmed.length > 0 ? trimmed : defaultValue;
    }
    return qgenValue;
  }
  
  // Fallback to process.env
  if (typeof process !== 'undefined' && process.env[varName]) {
    const envValue = process.env[varName];
    if (type === 'string') {
      const trimmed = envValue.trim();
      return trimmed.length > 0 ? trimmed : defaultValue;
    }
    if (type === 'number') {
      const num = Number(envValue);
      return !isNaN(num) ? num : defaultValue;
    }
    if (type === 'boolean') {
      return envValue.toLowerCase() === 'true';
    }
  }
  
  return defaultValue;
};

/**
 * Get required environment variable, throws if not found
 * @param varName - Environment variable name
 * @param type - Expected type ('string', 'number', 'boolean')
 * @returns Environment variable value
 */
export const requireEnvVar = (
  varName: string,
  type: 'string' | 'number' | 'boolean' = 'string'
): string | number | boolean => {
  const value = getEnvVar(varName, undefined, type);
  
  if (value === undefined || value === null) {
    // Try qgenutils requireEnvVars if available
    const requireEnvVars = (qgenutils as any).requireEnvVars;
    if (typeof requireEnvVars === 'function') {
      try {
        requireEnvVars([varName]);
        // Try reading again after requireEnvVars
        const retryValue = getEnvVar(varName, undefined, type);
        if (retryValue !== undefined && retryValue !== null) {
          return retryValue;
        }
      } catch (error) {
        if (qgenutils.logger?.warn) {
          qgenutils.logger.warn('requireEnvVar failed', {
            varName,
            errorMessage: error instanceof Error ? error.message : String(error)
          });
        }
      }
    }
    
    throw new Error(`Required environment variable ${varName} is not configured`);
  }
  
  return value;
};

/**
 * Get string environment variable with trimming and empty check
 * @param varName - Environment variable name
 * @param defaultValue - Default value if not found or empty
 * @returns String value or default
 */
export const getStringEnvVar = (varName: string, defaultValue?: string): string | undefined => {
  return getEnvVar(varName, defaultValue, 'string') as string | undefined;
};

/**
 * Get number environment variable with validation
 * @param varName - Environment variable name
 * @param defaultValue - Default value if not found or invalid
 * @returns Number value or default
 */
export const getNumberEnvVar = (varName: string, defaultValue?: number): number | undefined => {
  return getEnvVar(varName, defaultValue, 'number') as number | undefined;
};

/**
 * Get boolean environment variable
 * @param varName - Environment variable name
 * @param defaultValue - Default value if not found
 * @returns Boolean value or default
 */
export const getBooleanEnvVar = (varName: string, defaultValue?: boolean): boolean | undefined => {
  return getEnvVar(varName, defaultValue, 'boolean') as boolean | undefined;
};

/**
 * Check if running in test environment
 */
export const isTestEnvironment = (): boolean => {
  return getStringEnvVar('NODE_ENV') === 'test';
};

/**
 * Get logger instance from qgenutils with fallback
 */
export const getLogger = () => {
  const logger = (qgenutils as any).logger;
  return logger || {
    info: console.info.bind(console),
    warn: console.warn.bind(console),
    error: console.error.bind(console),
    debug: console.debug.bind(console)
  };
};