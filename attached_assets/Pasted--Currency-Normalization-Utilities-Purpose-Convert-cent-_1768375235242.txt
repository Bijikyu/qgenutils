/**
 * Currency Normalization Utilities
 *
 * Purpose: Convert cent-based Mongo aggregates into major currency units so analytics
 * payloads align with gateway expectations and UI displays. Shared across analytics helpers.
 */
import Big from 'big.js'; // rationale: precise decimal math avoids floating point drift during aggregation normalization

/**
 * Convert cent-denominated values into major currency units with two-decimal precision.
 *
 * @param value - Cent amount from Mongo aggregation.
 * @returns Number rounded to two decimals in major units.
 */
function centsToCurrency(value: unknown): number { // rationale: shared converter ensures consistent rounding across analytics outputs
  try {
    const cents = typeof value === 'number' ? value : Number(value || 0); // rationale: coerce mixed numeric types without throwing
    return Number(new Big(cents || 0).div(100).toFixed(2)); // rationale: divide by 100 using Big.js to avoid precision loss
  } catch {
    return 0; // rationale: fall back to zero to keep analytics resilient when upstream provides malformed data
  }
}

/**
 * Convert selected object properties from cents to currency in-place and return the mutated object.
 *
 * @param record - Object containing cent-based fields.
 * @param keys - Property names holding cent amounts.
 * @returns Record with normalized currency values.
 */
function normalizeCentFields<T extends Record<string, any>>(record: T, keys: Array<keyof T>): T { // rationale: helper applies converter across multiple fields succinctly
  for (const key of keys) {
    // eslint-disable-next-line no-param-reassign
    (record as any)[key] = centsToCurrency((record as any)[key]); // rationale: mutate record to keep downstream references synchronized
  }
  return record; // rationale: enable chaining by returning the same reference
}

export { centsToCurrency, normalizeCentFields }; // rationale: expose both granular converter and bulk normalizer for callers
export default centsToCurrency; // rationale: default export eases legacy import patterns in analytics helpers